const TelegramBot = require('node-telegram-bot-api');

// التوكن الخاص بك
const token = '8220823694:AAFlNjmbPryjRhyHTF9ue8ykiOJmWNEorY0';
const bot = new TelegramBot(token, { polling: true });

// تخزين بيانات المستخدمين
const userData = new Map();

// 100 جملة للاختبار
const texts = [
    "التقنية تجعل حياتنا أسهل وأكثر إنتاجية في كل المجالات",
    "الذكاء الاصطناعي يغير طريقة عملنا وتفاعلنا مع العالم من حولنا",
    "البرمجة مهارة أساسية في عصر الرقمية وتطور التكنولوجيا الحديثة",
    "الابتكار والتطوير المستمر هما مفتاح النجاح في مجال التكنولوجيا",
    "اللغات البرمجية تمكننا من بناء تطبيقات تخدم البشرية في مختلف المجالات",
    "التعلم المستمر يساعدنا على مواكبة التطورات السريعة في عالم التكنولوجيا",
    "الشبكات الاجتماعية أحدثت ثورة في طريقة تواصل الناس مع بعضهم البعض",
    "الأمن السيبراني أصبح ضرورة لحماية بياناتنا ومعلوماتنا الشخصية",
    "البيانات الضخمة تساعد الشركات على اتخاذ قرارات أكثر دقة وذكاء",
    "التعلم الآلي يمكن الأجهزة من تحسين أدائها ذاتياً دون برمجة مباشرة",
    "الحوسبة السحابية وفرت حلولاً مرنة لتخزين المعلومات ومعالجتها",
    "إنترنت الأشياء يربط الأجهزة المختلفة لتعمل بتناغم وذكاء",
    "التطبيقات الذكية سهلت إنجاز المهام اليومية بكل كفاءة وسرعة",
    "الواقع الافتراضي يفتح آفاقاً جديدة في مجال التعليم والترفيه",
    "البلوك تشين يضمن الشفافية والأمان في المعاملات الرقمية",
    "الروبوتات تؤدي مهام خطيرة ومتكررة بدقة عالية وبأخطاء أقل",
    "الطاقة المتجددة تحافظ على البيئة وتوفر موارد مستدامة للأجيال",
    "السفر والسياحة تثري الثقافة وتعزز التفاهم بين الشعوب المختلفة",
    "القراءة توسع المدارك وتنمي القدرة على التفكير النقدي والإبداعي",
    "الرياضة تحافظ على الصحة وتنمي روح العمل الجماعي والمنافسة الشريفة",
    "الفنون تعبر عن المشاعر وتثري الجانب الجمالي في حياة الإنسان",
    "اللغات تفتح أبواب التواصل مع ثقافات مختلفة حول العالم",
    "التخطيط الجيد يساعد في تحقيق الأهداف الشخصية والمهنية بكفاءة",
    "العمل التطوعي ينمي روح المسؤولية الاجتماعية والتعاطف مع الآخرين",
    "الصبر والتفاني أساس النجاح في أي مجال من مجالات الحياة",
    "التواصل الفعال يبني جسوراً قوية بين الأفراد والمجتمعات",
    "الاستماع الجيد مهارة مهمة لفهم الآخرين وتقدير وجهات نظرهم",
    "التفكير الإيجابي يساعد في تجاوز التحديات وتحقيق النجاحات",
    "التعاون والعمل الجماعي يؤديان إلى نتائج أفضل وإنجازات أكبر",
    "الإبداع والابتكار يميزان الأفراد والمنظمات الناجحة في عصرنا",
    "القيادة الفعالة تلهم الآخرين وتحفزهم على تحقيق أهداف مشتركة",
    "التعلم من الأخطاء يساعد في النمو والتطور المستمر للإنسان",
    "المرونة في التفكير تساعد على التكيف مع المتغيرات المستمرة",
    "الاحترام المتبادل أساس أي علاقة ناجحة سواء شخصية أو مهنية",
    "المعرفة قوة تمكن الإنسان من اتخاذ قرارات صائبة في الحياة",
    "الطموح يحفز الإنسان على السعي الدائم نحو الأفضل والإنجاز",
    "النظام والترتيب يساعدان في إدارة الوقت والموارد بكفاءة",
    "الصدق والأمانة يبنيان الثقة بين الأفراد والمجتمعات",
    "التسامح يجعل الحياة أجمل ويساعد في حل النزاعات بسلام",
    "الاجتهاد والمثابرة هما الطريق لتحقيق الأحلام والطموحات",
    "الطبيعة مصدر إلهام وجمال يجب الحفاظ عليه للأجيال القادمة",
    "الموسيقى لغة عالمية تعبر عن المشاعر وتوحد القلوب",
    "السعادة تكمن في الأشياء البسيطة واللحظات الجميلة في الحياة",
    "الصحة نعمة عظيمة يجب الحفاظ عليها بالعناية والاهتمام",
    "العائلة هي الدعم الأساسي والسند الحقيقي في حياة الإنسان",
    "الأصدقاء الحقيقيون كنز ثمين يضيء دروب الحياة المظلمة",
    "الضحك والدعابة يجعلان الحياة أخف وأكثر متعة وسعادة",
    "الحلم والطموح وقود يدفع الإنسان نحو التميز والإنجاز",
    "التحديات تصنع شخصيات قوية وقادرة على مواجهة الصعاب",
    "النجاح نتيجة طبيعية للعمل الجاد والتخطيط والالتزام",
    "الوقت كالسيف إن لم تقطعه قطعك لذا يجب استغلاله بحكمة",
    "المعرفة بدون تطبيق كالشجرة بلا ثمر لا فائدة منها",
    "التواضع صفة العظماء الذين يعرفون قيمة أنفسهم حقاً",
    "العطاء دون انتظار مقابل يجلب السعادة والرضا الداخلي",
    "الصمت في بعض الأوقات يكون أبلغ من الكلام وأكثر حكمة",
    "البساطة في الحياة تجعلها أكثر هدوءاً واستقراراً وسعادة",
    "التفاؤل ينير الطريق ويساعد في تجاوز العقبات والصعوبات",
    "الشجاعة ليست عدم الخوف بل القدرة على التصرف رغم الخوف",
    "الحكمة تأتي مع التجربة والتعلم من أخطاء الماضي",
    "النجاح رحلة مستمرة وليس محطة وصول ثابتة في الحياة",
    "الابتسامة لغة عالمية تفهمها جميع الثقافات والشعوب",
    "الاحترام يجذب الاحترام والحب يجلب الحب في الحياة",
    "التغيير يبدأ من الداخل ثم ينتقل إلى العالم من حولنا",
    "الطموح لا يعرف حدوداً ولا يتوقف عند أي عائق أو تحدي",
    "القراءة سفينة تعبر بنا بحور المعرفة والعلم والثقافة",
    "الصداقة نبع لا ينضب من الدعم والمشاركة والتفاهم",
    "العلم نور يضيء الطريق ويساعد في اتخاذ القرارات الصحيحة",
    "العمل الشريف شرف للإنسان ومصدر كرامته واستقلاله",
    "الحرية مسؤولية كبيرة تتطلب الحكمة في التصرف والاختيار",
    "الجمال الحقيقي ينبع من الداخل وليس من المظهر الخارجي",
    "الوفاء بالوعود يبني سمعة طيبة وثقة متبادلة بين الناس",
    "التعاطف مع الآخرين يجعل العالم مكاناً أفضل للعيش",
    "الإصرار والعزيمة يقودان إلى تحقيق المستحيل في الحياة",
    "الاستقلال المالي يمنح الإنسان حرية القرار والاختيار",
    "المرح والترفيه جزء مهم من حياة الإنسان المتوازنة",
    "الاستقرار النفسي أساس السعادة والنجاح في مختلف المجالات",
    "الطموح يحول الأحلام إلى واقع ملموس وإنجازات حقيقية",
    "التسامح يمحو الأحقاد ويملأ القلب بالسلام الداخلي",
    "الإبداع يحتاج إلى بيئة محفزة وداعمة للتعبير عن الذات",
    "المعرفة تزيد عندما نشاركها مع الآخرين ولا تنقص أبداً",
    "النجاح يحتاج إلى تخطيط واستراتيجية واضحة وثابتة",
    "الصبر مفتاح الفرج والحل للكثير من المشاكل والصعوبات",
    "التواصل الفعال يجنب سوء الفهم ويبني علاقات قوية",
    "الاحترام أساس التعامل بين الناس بغض النظر عن الاختلافات",
    "العطاء بلا حدود يجلب السعادة والبركة في حياة الإنسان",
    "التعلم من الآخرين يوسع المدارك وينمي القدرات الشخصية",
    "المرونة في التعامل تساعد على حل المشكلات بطرق إبداعية",
    "الطموح وقود يدفع الإنسان نحو التميز والتفوق المستمر",
    "الصدق في القول والعمل يبني ثقة متبادلة بين الأفراد",
    "التفكير الإيجابي يجلب الطاقة الإيجابية ويبعد السلبية",
    "العمل بروح الفريق يؤدي إلى إنجازات أكبر ونتائج أفضل",
    "الابتكار يحتاج إلى شجاعة وخروج عن المألوف والتقليد",
    "القراءة تنمي العقل وتوسع الخيال وتثري الثقافة الشخصية",
    "الصحة النفسية لا تقل أهمية عن الصحة الجسدية في الحياة",
    "الاستقرار العاطفي أساس العلاقات الناجحة والمستدامة",
    "التخطيط للمستقبل يساعد في تحقيق الأهداف والطموحات",
    "المثابرة والاستمرارية هما سر النجاح في أي مجال",
    "التواضع يجعل الإنسان محبوباً ومحترماً بين الناس",
    "الحلم الكبير يبدأ بخطوة صغيرة ولكن مستمرة ومتواصلة",
    "النجاح ليس صدفة بل نتيجة جهد وتخطيط ومثابرة",
    "السعادة الحقيقية تكمن في الرضا والقناعة الداخلية",
    "العطاء يجلب السعادة والفرح للقلب قبل المتلقي نفسه"
];

// أمر البدء
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from.id;
    
    userData.set(userId, {
        startTime: null,
        currentText: null,
        waitingForInput: false
    });
    
    const keyboard = {
        reply_markup: {
            keyboard: [
                [{ text: "11233 🚀 ابدأ الاختبار" }]
            ],
            resize_keyboard: true,
            one_time_keyboard: true
        }
    };
    
    bot.sendMessage(chatId, 
        "مرحباً! 👋 أنا بوت لقياس سرعة الكتابة (WPM)\n\n" +
        "اضغط على الزر أدناه لبدء اختبار سرعة الكتابة لديك:\n" +
        "✅ سأعطيك نصاً عشوائياً\n" +
        "⏱ سأحسب الوقت المستغرق\n" +
        "📊 سأعطيك سرعتك بالكلمات في الدقيقة",
        keyboard
    );
});

// معالجة الزر 11233 والرسائل النصية
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from.id;
    const text = msg.text;
    
    // إذا ضغط على الزر 11233
    if (text === "11233 🚀 ابدأ الاختبار") {
        if (!userData.has(userId)) {
            userData.set(userId, {});
        }
        
        // اختيار نص عشوائي من 100 جملة
        const randomText = texts[Math.floor(Math.random() * texts.length)];
        const user = userData.get(userId);
        
        user.currentText = randomText;
        user.waitingForInput = true;
        
        await bot.sendMessage(chatId, `📝 اكتب النص التالي بدقة:\n\n《 ${randomText} 》`);
        
        // العد التنازلي
        let countdown = 3;
        const countdownMsg = await bot.sendMessage(chatId, `⏰ سيبدأ الاختبار بعد: ${countdown}`);
        
        const countdownInterval = setInterval(async () => {
            countdown--;
            
            if (countdown > 0) {
                await bot.editMessageText(`⏰ سيبدأ الاختبار بعد: ${countdown}`, {
                    chat_id: chatId,
                    message_id: countdownMsg.message_id
                });
            } else {
                await bot.editMessageText("🚀 ابدأ الكتابة الآن!", {
                    chat_id: chatId,
                    message_id: countdownMsg.message_id
                });
                clearInterval(countdownInterval);
                
                user.startTime = new Date();
            }
        }, 1000);
        
        return;
    }
    
    // إذا كان يكتب النص للاختبار
    if (!userData.has(userId) || !userData.get(userId).waitingForInput) {
        return;
    }
    
    const user = userData.get(userId);
    user.waitingForInput = false;
    
    const originalText = user.currentText;
    const userText = text;
    
    if (originalText === userText) {
        const endTime = new Date();
        const startTime = user.startTime;
        
        const timeTaken = (endTime - startTime) / 1000; // بالثواني
        const wordsCount = originalText.split(' ').length;
        
        // حساب WPM (كلمات في الدقيقة)
        const wpm = (wordsCount / timeTaken) * 60;
        
        // تقييم السرعة
        let rating = "";
        if (wpm >= 60) rating = "🏆 سرعة ممتازة! أنت سريع جداً";
        else if (wpm >= 40) rating = "⭐ سرعة جيدة جداً";
        else if (wpm >= 25) rating = "👍 سرعة متوسطة جيدة";
        else rating = "💪 استمر في التمرين لتحسين سرعتك";
        
        const resultKeyboard = {
            reply_markup: {
                keyboard: [
                    [{ text: "11233 🔄 اختيار آخر" }]
                ],
                resize_keyboard: true,
                one_time_keyboard: true
            }
        };
        
        bot.sendMessage(chatId, 
            `✅ *ممتاز! كتبت النص بشكل صحيح*\n\n` +
            `⏱ *الوقت المستغرق:* ${timeTaken.toFixed(2)} ثانية\n` +
            `📊 *سرعتك:* ${wpm.toFixed(2)} كلمة/دقيقة\n` +
            `📝 *عدد الكلمات:* ${wordsCount} كلمة\n` +
            `🎯 *التقييم:* ${rating}\n\n` +
            `اضغط الزر لاختبار نص جديد:`,
            { 
                parse_mode: 'Markdown',
                reply_markup: resultKeyboard.reply_markup 
            }
        );
        
    } else {
        const retryKeyboard = {
            reply_markup: {
                keyboard: [
                    [{ text: "11233 🔄 حاول مرة أخرى" }]
                ],
                resize_keyboard: true,
                one_time_keyboard: true
            }
        };
        
        bot.sendMessage(chatId, 
            "❌ *النص غير مطابق تماماً*\n\n" +
            "⚠️ تأكد من:\n" +
            "• الكتابة بدون أخطاء إملائية\n" +
            "• عدم إضافة أو حذف أي حرف\n" +
            "• مطابقة النص حرفاً بحرف\n\n" +
            "اضغط الزر للمحاولة مرة أخرى:",
            { 
                parse_mode: 'Markdown',
                reply_markup: retryKeyboard.reply_markup 
            }
        );
    }
});

// لمنع التطبيق من التوقف
setInterval(() => {
    console.log('🤖 البوت لا يزال شغال...', new Date().toLocaleString());
}, 300000); // كل 5 دقائق

console.log('🚀 البوت يعمل بنجاح مع التوكن المطلوب...');
